import{e as f,f as h}from"./Bkm6qw8b.js";import{a as m}from"./BtuP6t-4.js";import{S as n}from"./9Qm2jZ7z.js";import{u as g}from"./u26IMBn3.js";const I=f("purchaseOrder",{state:()=>({purchaseOrders:[],purchaseOrder:null,loading:!0,error:null,totalRecords:0,params:{first:0,rows:10,sortField:"id",sortOrder:1,draw:1,search:""},form:{purchaseOrderItems:[]},isEditMode:!1,showModal:!1,validationErrors:[]}),actions:{async fetchPurchaseOrders(){var s;this.loading=!0,this.error=null;const{$api:a}=h();try{const e=localStorage.getItem("token"),t=new URL(a.purchaseOrder()),r=new URLSearchParams({page:(this.params.first/this.params.rows+1).toString(),rows:this.params.rows.toString(),sortField:this.params.sortField||"",sortOrder:((s=this.params.sortOrder)==null?void 0:s.toString())||"",draw:this.params.draw.toString(),search:this.params.search||""});t.search=r.toString();const o=await fetch(t,{method:"GET",headers:{Authorization:`Bearer ${e}`,Accept:"application/json","Content-Type":"application/json"},credentials:"include"});if(!o.ok)throw new Error("Gagal mengambil data purchaseOrder");const d=await o.json();this.purchaseOrders=d.data,this.totalRecords=d.meta.total}catch(e){console.error("Gagal mengambil data purchaseOrder:",e),this.error=e,n.fire("Error",`Tidak dapat memuat data Purchase Order: ${e.message}`,"error")}finally{this.loading=!1}},async savePurchaseOrder(){this.loading=!0,this.validationErrors=[];const{$api:a}=h(),s=g();try{const e=localStorage.getItem("token"),t=new FormData,r={...this.form};delete r.purchaseOrderItems,delete r.attachment,delete r.vendor,delete r.perusahaan,delete r.cabang,delete r.createdByUser,delete r.approvedByUser,delete r.receivedByUser,delete r.rejectedByUser,Object.keys(r).forEach(i=>{const c=r[i];c!=null&&t.append(i,c)}),!this.isEditMode&&s.user&&s.user.id&&(t.append("createdBy",s.user.id.toString()),this.form.status==="approved"&&t.append("approvedBy",s.user.id.toString()),this.form.status==="rejected"&&t.append("rejectedBy",s.user.id.toString())),this.form.attachment instanceof File&&t.append("attachment",this.form.attachment),this.form.purchaseOrderItems.forEach((i,c)=>{i.productId&&i.quantity>0&&Object.keys(i).forEach(u=>{const p=i[u];p!=null&&t.append(`purchaseOrderItems[${c}][${u}]`,p)})});const o=(this.isEditMode,"POST"),d=this.isEditMode?`${a.purchaseOrder()}/${this.form.id}`:a.purchaseOrder();this.isEditMode&&t.append("_method","PUT");const l=await fetch(d,{method:o,headers:{Authorization:`Bearer ${e}`,Accept:"application/json"},body:t,credentials:"include"});if(l.ok)this.closeModal(),await this.fetchPurchaseOrders(),n.fire("Berhasil!",`Purchase Order berhasil ${this.isEditMode?"diperbarui":"dibuat"}.`,"success");else{const i=await l.json();if(l.status===422)this.validationErrors=i.errors,n.fire("Gagal Validasi",i.errors.map(c=>c.message).join("<br>"),"error");else throw new Error(i.message||"Gagal menyimpan data purchaseOrder")}}catch(e){this.validationErrors=[],n.fire("Gagal",e.message||"Operasi gagal","error")}finally{this.loading=!1}},async deletePurchaseOrder(a){this.loading=!0;const{$api:s}=h();if(!(await n.fire({title:"Apakah Anda yakin?",text:"Data yang dihapus tidak dapat dikembalikan!",icon:"warning",showCancelButton:!0,confirmButtonColor:"#3085d6",cancelButtonColor:"#d33",confirmButtonText:"Ya, hapus!",cancelButtonText:"Batal"})).isConfirmed){this.loading=!1;return}try{const t=localStorage.getItem("token"),r=await fetch(`${s.purchaseOrder()}/${a}`,{method:"DELETE",headers:{Authorization:`Bearer ${t}`,Accept:"application/json"},credentials:"include"});if(!r.ok){const o=await r.json();throw new Error(o.message||"Gagal menghapus Sales Order")}await this.fetchPurchaseOrders(),n.fire("Berhasil!","Purchase Order berhasil dihapus.","success")}catch(t){n.fire("Error",t.message||"Gagal menghapus Purchase Order","error")}finally{this.loading=!1}},async approvePurchaseOrder(a){this.loading=!0,this.error=null;const{$api:s}=h();try{const e=localStorage.getItem("token"),t=await fetch(s.approvePurchaseOrder(a),{method:"PATCH",headers:{Authorization:`Bearer ${e}`,"Content-Type":"application/json",Accept:"application/json"},credentials:"include"});if(!t.ok){const r=await t.json().catch(()=>({message:"Gagal mengapprove purchase order"}));throw new Error(r.message||"Gagal mengapprove purchase order")}return await this.fetchPurchaseOrders(),await n.fire("Berhasil!","Purchase Order berhasil diapprove.","success"),!0}catch(e){return console.error("Error approving purchase order:",e),await n.fire("Error",e.message||"Gagal mengapprove purchase order.","error"),!1}finally{this.loading=!1}},async rejectPurchaseOrder(a){this.loading=!0,this.error=null;const{$api:s}=h();try{const e=localStorage.getItem("token"),t=await fetch(s.rejectPurchaseOrder(a),{method:"PATCH",headers:{Authorization:`Bearer ${e}`,"Content-Type":"application/json",Accept:"application/json"},credentials:"include"});if(!t.ok){const r=await t.json().catch(()=>({message:"Gagal mereject purchase order"}));throw new Error(r.message||"Gagal mereject purchase order")}return await this.fetchPurchaseOrders(),await n.fire("Berhasil!","Purchase Order berhasil direject.","success"),!0}catch(e){return console.error("Error rejecting purchase order:",e),await n.fire("Error",e.message||"Gagal mereject purchase order.","error"),!1}finally{this.loading=!1}},async updateStatusPartial(a,s,e){var r;this.loading=!0,this.error=null;const{$api:t}=h();try{const o=localStorage.getItem("token"),d=await m(t.purchaseOrderItemUpdateStatusPartial(a),{method:"PATCH",headers:{Authorization:`Bearer ${o}`,Accept:"application/json","Content-Type":"application/json"},body:{statusPartial:s,receivedQty:e},credentials:"include"}),l=d.data.purchaseOrderItem,i=d.data.purchaseOrder;if(this.purchaseOrder&&this.purchaseOrder.purchaseOrderItems){const c=this.purchaseOrder.purchaseOrderItems.findIndex(u=>u.id===a);c!==-1&&(this.purchaseOrder.purchaseOrderItems[c].statusPartial=l.statusPartial,this.purchaseOrder.purchaseOrderItems[c].receivedQty=l.receivedQty),this.purchaseOrder.status!==i.status&&(this.purchaseOrder.status=i.status)}}catch(o){throw console.error("Gagal memperbarui status item PO atau PO:",o),this.error=o,n.fire("Error",((r=o.data)==null?void 0:r.message)||o.message||"Operasi gagal","error"),o}finally{this.loading=!1}},openModal(a=null){if(this.isEditMode=!!a,this.validationErrors=[],a){const s=r=>r?new Date(r).toISOString().split("T")[0]:null,e={...JSON.parse(JSON.stringify(a)),attachment:null};["date","dueDate","approvedAt","receivedAt"].forEach(r=>{e[r]&&(e[r]=s(e[r]))}),this.form=e,(!this.form.purchaseOrderItems||this.form.purchaseOrderItems.length===0)&&(this.form.purchaseOrderItems=[],this.addItem())}else this.form={noPo:"",up:"",vendorId:null,perusahaanId:null,cabangId:null,date:new Date().toISOString().split("T")[0],dueDate:new Date().toISOString().split("T")[0],discountPercent:0,taxPercent:0,description:"",attachment:null,status:"draft",purchaseOrderItems:[]},this.addItem();this.showModal=!0},closeModal(){this.showModal=!1,this.isEditMode=!1,this.form={purchaseOrderItems:[]},this.validationErrors=[]},addItem(){this.form.purchaseOrderItems.push({productId:null,warehouseId:null,quantity:1,price:0,description:"",subtotal:0})},removeItem(a){this.form.purchaseOrderItems.splice(a,1)},setPagination(a){this.params.first=a.first,this.params.rows=a.rows,this.fetchPurchaseOrders()},setSort(a){this.params.sortField=a.sortField,this.params.sortOrder=a.sortOrder,this.fetchPurchaseOrders()},setSearch(a){this.params.search=a,this.params.first=0,this.fetchPurchaseOrders()},async getPurchaseOrderDetails(a){this.loading=!0,this.error=null;const{$api:s}=h();try{const e=localStorage.getItem("token"),t=await m(s.getPurchaseOrderDetails(a),{headers:{Authorization:`Bearer ${e}`,Accept:"application/json"},credentials:"include"});if(t&&t.data)this.purchaseOrder=t.data;else throw new Error("Struktur data tidak valid diterima dari API getPurchaseOrderDetails.")}catch(e){console.error("Gagal mengambil detail purchase order:",e),this.error=e}finally{this.loading=!1}}}});export{I as u};
