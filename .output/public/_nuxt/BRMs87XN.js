import{e as m,f as c}from"./Bkm6qw8b.js";import{S as i}from"./9Qm2jZ7z.js";const g=m("customer",{state:()=>({customers:[],selectedCustomer:null,loading:!1,error:null,totalRecords:0,params:{first:0,rows:10,sortField:"id",sortOrder:1,search:""},form:{name:"",address:"",email:"",phone:"",npwp:"",logo:"",customerProducts:[]},isEditMode:!1,showModal:!1,validationErrors:[]}),actions:{async fetchCustomers(){this.loading=!0,this.error=null;const{$api:t}=c();try{const s=localStorage.getItem("token"),a=new URLSearchParams({page:(this.params.first/this.params.rows+1).toString(),rows:this.params.rows.toString(),sortField:this.params.sortField||"",sortOrder:(this.params.sortOrder||1)>0?"asc":"desc",search:this.params.search||""}),e=await fetch(`${t.customer()}?${a.toString()}`,{headers:{Authorization:`Bearer ${s}`,"Content-Type":"application/json",Accept:"application/json"},credentials:"include"});if(!e.ok){const r=await e.json().catch(()=>({message:"Gagal memuat data pelanggan."}));throw new Error(r.message||"Gagal memuat data pelanggan.")}const o=await e.json();this.customers=o.data,this.totalRecords=o.meta.total}catch(s){this.error=s.message,i.fire("Error",`Tidak dapat memuat data pelanggan: ${s.message}`,"error")}finally{this.loading=!1}},async prefetchCustomers(){this.customers.length>0||this.loading||await this.fetchCustomers()},async saveCustomer(){this.loading=!0,this.validationErrors=[];const{$api:t}=c();try{const s=localStorage.getItem("token"),a=new FormData;Object.keys(this.form).forEach(l=>{const n=this.form[l];l==="logo"&&n instanceof File?a.append(l,n):l==="customerProducts"&&Array.isArray(n)?n.forEach((d,h)=>{d.productId&&a.append(`customerProducts[${h}][productId]`,String(d.productId)),a.append(`customerProducts[${h}][priceSell]`,String(d.priceSell))}):n!=null&&l!=="logo"&&a.append(l,String(n))});let e=t.customer();this.isEditMode&&this.form.id&&(e=`${t.customer()}/${this.form.id}`,a.append("_method","PUT"));const o=await fetch(e,{method:"POST",body:a,headers:{Authorization:`Bearer ${s}`,Accept:"application/json"},credentials:"include"}),r=await o.json();if(!o.ok)throw r.errors&&(this.validationErrors=Object.values(r.errors).flat()),new Error(r.message||"Gagal menyimpan data pelanggan");this.closeModal(),await this.fetchCustomers(),i.fire("Berhasil!",`Pelanggan berhasil ${this.isEditMode?"diperbarui":"disimpan"}.`,"success")}catch(s){i.fire("Error",s.message||"Operasi gagal","error")}finally{this.loading=!1}},async deleteCustomer(t){const{$api:s}=c();if((await i.fire({title:"Apakah Anda yakin?",text:"Data pelanggan yang dihapus tidak dapat dikembalikan!",icon:"warning",showCancelButton:!0,confirmButtonColor:"#3085d6",cancelButtonColor:"#d33",confirmButtonText:"Ya, hapus!",cancelButtonText:"Batal"})).isConfirmed){this.loading=!0;try{const e=localStorage.getItem("token"),o=await fetch(s.customer()+`/${t}`,{method:"DELETE",headers:{Authorization:`Bearer ${e}`,Accept:"application/json"},credentials:"include"});if(!o.ok){const r=await o.json();throw new Error(r.message||"Gagal menghapus pelanggan")}await this.fetchCustomers(),i.fire("Berhasil!","Pelanggan berhasil dihapus.","success")}catch(e){i.fire("Error",e.message||"Gagal menghapus pelanggan","error")}finally{this.loading=!1}}},async getCustomerDetails(t){this.loading=!0,this.error=null;const{$api:s}=c();try{const a=localStorage.getItem("token"),e=await fetch(`${s.customer()}/${t}`,{headers:{Authorization:`Bearer ${a}`,Accept:"application/json"},credentials:"include"});if(!e.ok){const r=await e.json().catch(()=>({message:"Gagal memuat detail pelanggan."}));throw new Error(r.message||"Gagal memuat detail pelanggan.")}const o=await e.json();this.selectedCustomer=o.data}catch(a){this.error=a.message,this.selectedCustomer=null,i.fire("Error",`Tidak dapat memuat detail pelanggan: ${a.message}`,"error")}finally{this.loading=!1}},async openModal(t=null){if(this.isEditMode=!!t,this.validationErrors=[],t&&t.id){this.loading=!0;const{$api:s}=c(),a=localStorage.getItem("token");try{const e=await fetch(`${s.customer()}/${t.id}`,{headers:{Authorization:`Bearer ${a}`,Accept:"application/json"},credentials:"include"});if(!e.ok)throw new Error("Gagal mengambil detail data pelanggan.");const r=(await e.json()).data;this.form={...r,customerProducts:r.customerProducts&&r.customerProducts.length>0?r.customerProducts:[{productId:null,priceSell:0}]}}catch(e){i.fire("Error",e.message,"error")}finally{this.loading=!1}}else this.form={name:"",address:"",email:"",phone:"",npwp:"",logo:"",customerProducts:[{productId:null,priceSell:0}]};this.showModal=!0},closeModal(){this.showModal=!1,this.isEditMode=!1,this.form={},this.validationErrors=[]},setPagination(t){this.params.first=t.first,this.params.rows=t.rows,this.fetchCustomers()},setSort(t){this.params.sortField=t.sortField,this.params.sortOrder=t.sortOrder,this.fetchCustomers()},setSearch(t){this.params.search=t,this.params.first=0,this.fetchCustomers()},handleLogoChange(t){t&&(this.form.logo=t)},addItem(){this.form.customerProducts||(this.form.customerProducts=[]),this.form.customerProducts.push({productId:null,priceSell:0})},removeItem(t){this.form.customerProducts&&this.form.customerProducts.splice(t,1)}}});export{g as u};
