import{e as rt,f as $,_ as it,j as x,s as N,k as D,l as G,K as nt,g as lt,c as y,a as e,b as u,m as A,n as T,i as r,d as b,w as O,D as dt,r as ct,o as k,q as ut,v as mt,t as _,y as ft,F as ht,x as pt,z as kt,A as L,B as z}from"./Bkm6qw8b.js";import{u as gt}from"./u26IMBn3.js";import{u as wt}from"./WyHMcmGb.js";import{_ as St}from"./BAMzpvu1.js";import{_ as M}from"./CdgIhitS.js";import{_ as yt}from"./DleeVanq.js";import{S as w}from"./9Qm2jZ7z.js";import{C as U}from"./D9zIpW-x.js";import"./D1pefl20.js";const vt=rt("stockOut",{state:()=>({stockOuts:[],stockOutDetails:[],selectedStockOut:null,totalRecords:0,stats:{total:void 0,draft:void 0,posted:void 0},loading:!1,error:null,params:{first:0,rows:10,sortField:null,sortOrder:null,draw:1,search:""},form:{},isEditMode:!1,showModal:!1,validationErrors:[]}),actions:{async fetchStockOutsPaginated(){this.loading=!0;try{const{$api:s}=$(),i=localStorage.getItem("token"),c=new URLSearchParams({page:(this.params.first/this.params.rows+1).toString(),rows:this.params.rows.toString(),sortField:this.params.sortField||"",sortOrder:this.params.sortOrder?this.params.sortOrder.toString():"",draw:(this.params.draw||1).toString(),search:this.params.search||""}),n=await fetch(`${s.stockOut()}?${c.toString()}`,{headers:{Authorization:`Bearer ${i}`,"Content-Type":"application/json",Accept:"application/json"}});if(!n.ok){const f=await n.json().catch(()=>({message:"Gagal memuat data stock out dengan status: "+n.status}));throw new Error(f.message||"Gagal memuat data stock out")}const o=await n.json();return this.stockOuts=o.data||[],this.totalRecords=parseInt(o.meta.total)||0,o}catch(s){throw this.stockOuts=[],this.totalRecords=0,s}finally{this.loading=!1}},async saveStockOut(){var s;this.loading=!0;try{const{$api:i}=$(),o=(await(await fetch(i.csrfToken(),{credentials:"include"})).json()).token||((s=document.querySelector('meta[name="csrf-token"]'))==null?void 0:s.content),f=localStorage.getItem("token");let g,h;const m={noSo:this.form.noSo,date:this.form.date,warehouseId:this.form.warehouseId,status:this.form.status};if(this.isEditMode){if(!this.form.id)throw new Error("ID Stock Out tidak ditemukan untuk update.");h=`${i.stockOut()}/${this.form.id}`,g=await fetch(h,{method:"PUT",body:JSON.stringify(m),headers:{Authorization:`Bearer ${f}`,"Content-Type":"application/json"},credentials:"include"})}else m.status="draft",h=i.stockOut(),g=await fetch(h,{method:"POST",body:JSON.stringify(m),headers:{Authorization:`Bearer ${f}`,"Content-Type":"application/json"},credentials:"include"});if(!g.ok)throw await g.json().catch(()=>({message:`Gagal ${this.isEditMode?"memperbarui":"membuat"} stock out`}));return await g.json()}catch(i){throw i}finally{this.loading=!1}},async fetchStockOuts(){try{this.loading=!0;const{$api:s}=$(),i=`${s.stockOut()}`,c=localStorage.getItem("token"),n=await fetch(i,{headers:{Accept:"application/json",Authorization:`Bearer ${c}`},credentials:"include"});if(!n.ok){const f=await n.text();throw new Error(`Failed to fetch Stock Out details! status: ${n.status}. Response: ${f}`)}const o=await n.json();this.stockOuts=o,console.log("Pinia store stockOut state after refresh load:",this.stockOuts)}catch(s){console.error("Error fetching stock out details:",s),this.error=s}finally{this.loading=!1}},async deleteStockOut(s){this.loading=!0,this.error=null;try{const{$api:i}=$(),c=localStorage.getItem("token"),n=await fetch(i.csrfToken(),{credentials:"include"});if(!n.ok)throw new Error("Gagal mengambil token CSRF");const f=(await n.json()).token,g=`${i.stockOut()}/${s}`,h=await fetch(g,{method:"DELETE",headers:{Authorization:`Bearer ${c}`,"Content-Type":"application/json"},credentials:"include"});if(!h.ok){const m=await h.json().catch(()=>({message:"Gagal menghapus stock out"}));throw new Error(m.message)}return!0}catch(i){throw console.error("Terjadi kesalahan saat menghapus stock out:",i),i}finally{this.loading=!1}},async postStockOut(s){try{const{$api:i}=$(),c=localStorage.getItem("token"),n=await fetch(i.csrfToken(),{credentials:"include"});if(!n.ok)throw new Error("Gagal mengambil token CSRF");const f=(await n.json()).token,g=`${i.postStockOut(s)}`,h=await fetch(g,{method:"POST",headers:{Authorization:`Bearer ${c}`,"Content-Type":"application/json"},credentials:"include"});if(!h.ok){const m=await h.json().catch(()=>({message:"Gagal memposting stock out"}));throw new Error(m.message)}return!0}catch(i){throw console.error("Error posting stock out:",i),this.error=i,i}finally{this.loading=!1}},async fetchStats(){const s={total:void 0,draft:void 0,posted:void 0};try{const{$api:i}=$(),c=localStorage.getItem("token"),n=await fetch(i.countStockOut(),{headers:{Authorization:`Bearer ${c}`,"Content-Type":"application/json"}});if(n.ok){const o=await n.json();o&&typeof o=="object"&&o!==null?this.stats={total:o.total,draft:o.draft,posted:o.posted}:(this.stats=s,console.warn("Data statistik dari API tidak dalam format objek yang diharapkan atau null:",o))}else this.stats=s,console.error("Gagal mengambil data statistik, status respons:",n.status)}catch(i){console.error("Gagal mengambil data statistik (exception):",i),this.stats=s,this.error=i}},openModal(s=null){this.isEditMode=!!s,this.validationErrors=[],s?this.form={...JSON.parse(JSON.stringify(s)),date:s.date?new Date(s.date).toISOString().slice(0,10):""}:this.form={noSo:"",date:"",status:""},this.showModal=!0},closeModal(){this.showModal=!1,this.isEditMode=!1,this.form={},this.validationErrors=[]},setPagination(s){this.params.first=s.first,this.params.rows=s.rows,this.fetchStockOutsPaginated()},setSort(s){this.params.sortField=s.sortField,this.params.sortOrder=s.sortOrder,this.fetchStockOutsPaginated()},setSearch(s){this.params.search=s,this.params.first=0,this.fetchStockOutsPaginated()},handleRowsChange(){this.params.first=0,this.fetchStockOutsPaginated()},async fetchStockOutById(s){this.loading=!0,this.error=null;try{const{$api:i}=$(),c=localStorage.getItem("token"),n=await fetch(`${i.stockOutDetail()}/${s}`,{headers:{Authorization:`Bearer ${c}`,"Content-Type":"application/json",Accept:"application/json"}});if(!n.ok){const f=await n.json().catch(()=>({message:"Gagal memuat data stock out"}));throw new Error(f.message)}const o=await n.json();this.selectedStockOut=o}catch(i){throw this.error=i,i}finally{this.loading=!1}},resetStockOut(){this.selectedStockOut=null,this.error=null}}}),bt={class:"content-wrapper"},Ot={class:"container-xxl flex-grow-1 container-p-y"},_t={class:"row g-6 mb-6"},$t={class:"row g-6"},Tt={class:"col-12"},Ct={class:"card"},xt={class:"card-header d-flex justify-content-between align-items-center flex-wrap"},Et={class:"d-flex align-items-center me-3 mb-2 mb-md-0"},jt={class:"d-flex align-items-center"},Dt={class:"btn-group me-2"},Bt={class:"dropdown-menu"},At={class:"input-group"},Mt={class:"p-input-icon-left"},Pt={class:"card-datatable table-responsive py-3 px-3"},Rt={class:"badge bg-primary"},It={key:0},Vt={class:"list-unstyled mb-0"},Ft={class:"fw-bold"},Nt={key:1},Gt={class:"d-inline-block"},Lt={class:"dropdown-menu"},zt={key:0},Ut=["onClick"],qt={key:1},Jt=["onClick"],Qt={key:2},Wt=["onClick"],Ht={key:3},Kt=["onClick"],Yt={class:"row g-6"},Xt={class:"col-md-6"},Zt={class:"form-floating form-floating-outline"},te={class:"col-md-6"},ee={class:"form-floating form-floating-outline"},ae={class:"col-md-6"},se={class:"form-floating form-floating-outline"},oe={class:"col-md-6"},re={class:"form-floating form-floating-outline"},ie={class:"d-flex justify-content-end"},ne={__name:"stock-out",setup(s){const{$api:i}=$(),c=x(null),n=gt(),o=vt(),f=wt(),{stockOuts:g,totalRecords:h,stats:m,params:v,form:S,isEditMode:C,showModal:q,validationErrors:J}=N(o),{warehouse:Q}=N(f),W=x(null),H=x(!1),B=x(""),K=dt(),E=D(()=>{var l,t;return((t=(l=n.user)==null?void 0:l.roles)==null?void 0:t.some(d=>d.name==="superadmin"))??!1}),Y=D(()=>{var l,t;return((t=(l=n.user)==null?void 0:l.roles)==null?void 0:t.some(d=>d.name==="admin"))??!1}),X=x([{label:"Draft",value:"draft"},{label:"Posted",value:"posted"}]),Z=x([10,25,50,100]),tt=D(()=>C.value?"Edit Stock Out":"Tambah Stock Out"),et=D(()=>C.value?"Silakan ubah data stock out di bawah ini.":"Silakan isi form di bawah ini untuk menambahkan stock out baru.");G(q,l=>{const t=document.getElementById("Modal");if(t&&window.bootstrap){const d=bootstrap.Modal.getInstance(t)||new bootstrap.Modal(t);l?d.show():d.hide()}});let j=null;G(B,l=>{j&&clearTimeout(j),j=setTimeout(()=>{o.setSearch(l)},500)}),nt(()=>{j&&clearTimeout(j)});const P=async()=>{if(!S.value.noSo)return w.fire("Validasi","No SO wajib diisi.","warning");try{await o.saveStockOut(),await o.fetchStockOutsPaginated(),o.closeModal(),w.fire("Berhasil!",`Stock Out berhasil ${C.value?"diperbarui":"dibuat"}.`,"success")}catch(l){const t=l;t.errors?(o.validationErrors=Array.isArray(t.errors)?t.errors:Object.values(t.errors).flat(),w.fire("Gagal","Terdapat kesalahan validasi data.","error")):w.fire("Gagal",t.message||`Gagal ${C.value?"memperbarui":"membuat"} stock out`,"error")}},at=async l=>{try{await o.postStockOut(l),await o.fetchStockOutsPaginated(),await w.fire("Berhasil!","Stock Out berhasil diposting.","success")}catch(t){let d="Gagal memposting stock out";t instanceof Error?d=t.message:typeof t=="string"&&(d=t);try{const a=JSON.parse(d);if(a.errors)return o.validationErrors=Array.isArray(a.errors)?a.errors:Object.values(a.errors).flat(),w.fire("Gagal","Terdapat kesalahan validasi data.","error");d=a.message||d}catch{}await w.fire("Error",d,"error")}},R=async()=>{try{await o.fetchStockOutsPaginated()}catch(l){const t=l.message;w.fire("Error",`Tidak dapat memuat data stock out: ${t}`,"error")}};lt(()=>{R(),o.fetchStats(),f.fetchWarehouses()});const I=l=>{l==="csv"?c.value.exportCSV():l==="pdf"&&c.value.exportPDF()},st=l=>{K.push({path:"/inventory/stock-out-detail",query:{id:l}})},ot=async l=>{if(!l)return;if((await w.fire({title:"Apakah Anda yakin?",text:"Tindakan ini tidak bisa dibatalkan!",icon:"warning",showCancelButton:!0,confirmButtonColor:"#666CFF",cancelButtonColor:"#A7A9B3",confirmButtonText:"Ya, hapus!",cancelButtonText:"Batal"})).isConfirmed)try{await o.deleteStockOut(l),R(),await w.fire({title:"Berhasil!",text:"Stock Out berhasil dihapus.",icon:"success"})}catch(d){await w.fire({title:"Error",text:d.message,icon:"error"})}},V=l=>{switch(l){case"draft":return{text:"Draft",class:"badge rounded-pill bg-label-secondary"};case"posted":return{text:"Posted",class:"badge rounded-pill bg-label-success"}}};return(l,t)=>{const d=ct("Column");return k(),y("div",bt,[e("div",Ot,[t[21]||(t[21]=e("h4",{class:"mb-1"},"List Stock Out",-1)),t[22]||(t[22]=e("p",{class:"mb-6"}," List stock out yang terdaftar di sistem ",-1)),e("div",_t,[r(m).total!==void 0?(k(),A(M,{key:0,title:"Total Stock Out",total:r(m).total+" Stock Out"},null,8,["total"])):T("",!0),r(m).draft!==void 0?(k(),A(M,{key:1,title:"Total Stock Out Draft",total:r(m).draft+" Stock Out"},null,8,["total"])):T("",!0),r(m).posted!==void 0?(k(),A(M,{key:2,title:"Total Stock Out Posted",total:r(m).posted+" Stock Out"},null,8,["total"])):T("",!0)]),e("div",$t,[t[18]||(t[18]=e("div",{class:"col-12"},[e("h4",{class:"mt-6 mb-1"},"Total Stock Out"),e("p",{class:"mb-0"},"Find all of your company's administrator accounts and their associate Stock Out.")],-1)),e("div",Tt,[e("div",Ct,[e("div",xt,[e("div",Et,[t[11]||(t[11]=e("span",{class:"me-2"},"Baris:",-1)),u(r(ut),{modelValue:r(v).rows,"onUpdate:modelValue":t[0]||(t[0]=a=>r(v).rows=a),options:Z.value,onChange:r(o).handleRowsChange,placeholder:"Jumlah",style:{width:"8rem"}},null,8,["modelValue","options","onChange"])]),e("div",jt,[e("div",Dt,[t[12]||(t[12]=e("button",{class:"btn btn-secondary dropdown-toggle",type:"button","data-bs-toggle":"dropdown","aria-expanded":"false"},[e("i",{class:"ri-upload-2-line me-1"}),b(" Export ")],-1)),e("ul",Bt,[e("li",null,[e("a",{class:"dropdown-item",href:"javascript:void(0)",onClick:t[1]||(t[1]=a=>I("csv"))},"CSV")]),e("li",null,[e("a",{class:"dropdown-item",href:"javascript:void(0)",onClick:t[2]||(t[2]=a=>I("pdf"))},"PDF")])])]),e("div",At,[e("span",Mt,[u(r(mt),{modelValue:B.value,"onUpdate:modelValue":t[3]||(t[3]=a=>B.value=a),placeholder:"Cari Stock Out...",class:"w-full md:w-20rem"},null,8,["modelValue"])])])])]),e("div",Pt,[u(yt,{ref_key:"myDataTableRef",ref:c,data:r(g),rows:r(v).rows,loading:H.value,totalRecords:r(h),lazy:!0,onPage:t[4]||(t[4]=a=>r(o).setPagination(a)),onSort:t[5]||(t[5]=a=>r(o).setSort(a)),responsiveLayout:"scroll",paginatorPosition:"bottom",paginatorTemplate:"CurrentPageReport FirstPageLink PrevPageLink PageLinks NextPageLink LastPageLink",currentPageReportTemplate:"Menampilkan {first} sampai {last} dari {totalRecords} data"},{default:O(()=>[u(d,{header:"#",sortable:!1},{body:O(a=>[b(_(Number.isFinite(r(v).page)&&Number.isFinite(r(v).rows)?(r(v).page-1)*r(v).rows+a.index+1:a.index+1),1)]),_:1}),u(d,{field:"noSo",header:"No. Stock Out",sortable:!0},{body:O(a=>[e("span",Rt,_(a.data.noSo),1)]),_:1}),u(d,{field:"date",header:"Tanggal",sortable:!0,style:{width:"10%"}},{body:O(a=>[b(_(a.data.date?new Date(a.data.date).toLocaleDateString():"-"),1)]),_:1}),u(d,{field:"salesOrder.noSo",header:"No. SO",sortable:!0,class:"text-nowrap"}),u(d,{field:"status",header:"Status",sortable:!0},{body:O(a=>[e("span",{class:ft(V(a.data.status).class)},_(V(a.data.status).text),3)]),_:1}),u(d,{field:"warehouse.name",header:"Gudang",sortable:!0}),u(d,{header:"Produk Dikeluarkan",style:{"min-width":"10rem"}},{body:O(a=>[a.data.salesOrder&&a.data.salesOrder.salesOrderItems&&a.data.salesOrder.salesOrderItems.length?(k(),y("div",It,[e("ul",Vt,[(k(!0),y(ht,null,pt(a.data.salesOrder.salesOrderItems,p=>{var F;return k(),y("li",{key:p.id},[e("span",Ft,_(((F=p.product)==null?void 0:F.name)||"N/A")+":",1),b(" "+_(p.deliveredQty!==void 0&&p.deliveredQty!==null?String(p.deliveredQty).replace(/\.00$/,""):0)+" / "+_(p.quantity!==void 0&&p.quantity!==null?String(p.quantity).replace(/\.00$/,""):0),1)])}),128))])])):(k(),y("span",Nt,"-"))]),_:1}),u(d,{field:"salesOrder.deliveredByUser.fullName",header:"Pengirim",sortable:!0}),u(d,{header:"Actions",exportable:!1,style:{"min-width":"8rem"}},{body:O(a=>[e("div",Gt,[t[17]||(t[17]=e("a",{href:"javascript:;",class:"btn btn-sm btn-text-secondary rounded-pill btn-icon dropdown-toggle hide-arrow","data-bs-toggle":"dropdown"},[e("i",{class:"ri-more-2-fill"})],-1)),e("ul",Lt,[Y.value||E.value&&a.data.status=="draft"?(k(),y("li",zt,[e("a",{class:"dropdown-item",href:"javascript:void(0)",onClick:p=>at(a.data.id)},t[13]||(t[13]=[e("i",{class:"ri-upload-2-line me-2"},null,-1),b(" Post ")]),8,Ut)])):T("",!0),a.data.status=="posted"?(k(),y("li",qt,[e("a",{class:"dropdown-item",href:"javascript:void(0)",onClick:p=>st(a.data.id)},t[14]||(t[14]=[e("i",{class:"ri-eye-line me-2"},null,-1),b(" Lihat Detail ")]),8,Jt)])):T("",!0),E.value||!E.value&&a.data.status=="draft"?(k(),y("li",Qt,[e("a",{class:"dropdown-item",href:"javascript:void(0)",onClick:p=>r(o).openModal(a.data)},t[15]||(t[15]=[e("i",{class:"ri-edit-box-line me-2"},null,-1),b(" Edit ")]),8,Wt)])):T("",!0),E.value||!E.value&&a.data.status=="Received"?(k(),y("li",Ht,[e("a",{class:"dropdown-item text-danger",href:"javascript:void(0)",onClick:p=>ot(a.data.id)},t[16]||(t[16]=[e("i",{class:"ri-delete-bin-7-line me-2"},null,-1),b(" Hapus ")]),8,Kt)])):T("",!0)])])]),_:1})]),_:1},8,["data","rows","loading","totalRecords"])])])])]),u(St,{isEditMode:r(C),validationErrorsFromParent:r(J),title:tt.value,description:et.value,selectedStockOut:W.value},{default:O(()=>[e("form",{onSubmit:kt(P,["prevent"])},[e("div",Yt,[e("div",Xt,[e("div",Zt,[L(e("input",{type:"text",class:"form-control",id:"name","onUpdate:modelValue":t[6]||(t[6]=a=>r(S).noSo=a),placeholder:"Masukkan no SO",required:""},null,512),[[z,r(S).noSo]]),t[19]||(t[19]=e("label",{for:"name"},"No SO",-1))])]),e("div",te,[e("div",ee,[L(e("input",{type:"date",class:"form-control",id:"date","onUpdate:modelValue":t[7]||(t[7]=a=>r(S).date=a),placeholder:"Masukkan tanggal",required:""},null,512),[[z,r(S).date]]),t[20]||(t[20]=e("label",{for:"name"},"Tanggal",-1))])]),e("div",ae,[e("div",se,[u(r(U),{modelValue:r(S).warehouseId,"onUpdate:modelValue":t[8]||(t[8]=a=>r(S).warehouseId=a),options:r(Q),label:"name",reduce:a=>a.id,placeholder:"-- Pilih Gudang --",class:"warehouse-select"},null,8,["modelValue","options","reduce"])])]),e("div",oe,[e("div",re,[u(r(U),{modelValue:r(S).status,"onUpdate:modelValue":t[9]||(t[9]=a=>r(S).status=a),options:X.value,label:"label",reduce:a=>a.value,placeholder:"-- Pilih Status --",class:"status-select"},null,8,["modelValue","options","reduce"])])]),e("div",ie,[e("button",{type:"submit",class:"btn btn-primary me-2",onClick:P},_(r(C)?"Update":"Simpan"),1),e("button",{type:"button",class:"btn btn-secondary",onClick:t[10]||(t[10]=a=>r(o).closeModal())}," Batal ")])])],32)]),_:1},8,["isEditMode","validationErrorsFromParent","title","description","selectedStockOut"])]),t[23]||(t[23]=e("div",{class:"content-backdrop fade"},null,-1))])}}},ge=it(ne,[["__scopeId","data-v-cb062e60"]]);export{ge as default};
