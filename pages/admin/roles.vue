<template>
    <!-- Content wrapper -->
    <div class="content-wrapper">
         <!-- Content -->
 
         <div class="container-xxl flex-grow-1 container-p-y">
             <h4 class="mb-1">Roles List</h4>
             <p class="mb-6">
             A role provided access to predefined menus and features so that depending on assigned role an
             administrator can have access to what user needs.
             </p>
             <!-- Role cards -->
             <div class="row g-6">
                 <div class="col-xl-4 col-lg-6 col-md-6">
                     <div class="card">
                     <div class="card-body">
                         <div class="d-flex justify-content-between align-items-center mb-4">
                         <p class="mb-0">Total 4 users</p>
                         <ul class="list-unstyled d-flex align-items-center avatar-group mb-0">
                             <li
                             data-bs-toggle="tooltip"
                             data-popup="tooltip-custom"
                             data-bs-placement="top"
                             title="Vinnie Mostowy"
                             class="avatar pull-up">
                             <img class="rounded-circle" src="/img/avatars/5.png" alt="Avatar" />
                             </li>
                             <li
                             data-bs-toggle="tooltip"
                             data-popup="tooltip-custom"
                             data-bs-placement="top"
                             title="Allen Rieske"
                             class="avatar pull-up">
                             <img class="rounded-circle" src="/img/avatars/12.png" alt="Avatar" />
                             </li>
                             <li
                             data-bs-toggle="tooltip"
                             data-popup="tooltip-custom"
                             data-bs-placement="top"
                             title="Julee Rossignol"
                             class="avatar pull-up">
                             <img class="rounded-circle" src="/img/avatars/6.png" alt="Avatar" />
                             </li>
                             <li class="avatar">
                             <span
                                 class="avatar-initial rounded-circle pull-up bg-lighter text-body"
                                 data-bs-toggle="tooltip"
                                 data-bs-placement="bottom"
                                 title="3 more"
                                 >+3</span
                             >
                             </li>
                         </ul>
                         </div>
                         <div class="d-flex justify-content-between align-items-center">
                         <div class="role-heading">
                             <h5 class="mb-1">Administrator</h5>
                             <a
                             href="javascript:;"
                             data-bs-toggle="modal"
                             data-bs-target="#RoleModal"
                             class="role-edit-modal">
                             <p class="mb-0">Edit Role</p>
                             </a>
                         </div>
                         <a href="javascript:void(0);" class="text-secondary"
                             ><i class="ri-file-copy-line ri-22px"></i
                         ></a>
 </div>
                     </div>
                     </div>
                 </div>
                 <div class="col-xl-4 col-lg-6 col-md-6">
                     <div class="card">
                     <div class="card-body">
                         <div class="d-flex justify-content-between align-items-center mb-4">
                         <p class="mb-0">Total 7 users</p>
                         <ul class="list-unstyled d-flex align-items-center avatar-group mb-0">
                             <li
                             data-bs-toggle="tooltip"
                             data-popup="tooltip-custom"
                             data-bs-placement="top"
                             title="Jimmy Ressula"
                             class="avatar pull-up">
                             <img class="rounded-circle" src="/img/avatars/4.png" alt="Avatar" />
                             </li>
                             <li
                             data-bs-toggle="tooltip"
                             data-popup="tooltip-custom"
                             data-bs-placement="top"
                             title="John Doe"
                             class="avatar pull-up">
                             <img class="rounded-circle" src="/img/avatars/1.png" alt="Avatar" />
                             </li>
                             <li
                             data-bs-toggle="tooltip"
                             data-popup="tooltip-custom"
                             data-bs-placement="top"
                             title="Kristi Lawker"
                             class="avatar pull-up">
                             <img class="rounded-circle" src="/img/avatars/2.png" alt="Avatar" />
                             </li>
                             <li class="avatar">
                             <span
                                 class="avatar-initial rounded-circle pull-up bg-lighter text-body"
                                 data-bs-toggle="tooltip"
                                 data-bs-placement="bottom"
                                 title="3 more"
                                 >+3</span
                             >
                             </li>
                         </ul>
                         </div>
                         <div class="d-flex justify-content-between align-items-center">
                         <div class="role-heading">
                             <h5 class="mb-1">Editor</h5>
                             <a
                             href="javascript:;"
                             data-bs-toggle="modal"
                             data-bs-target="#RoleModal"
                             class="role-edit-modal">
                             <p class="mb-0">Edit Role</p>
                             </a>
                         </div>
                         <a href="javascript:void(0);" class="text-secondary"
                             ><i class="ri-file-copy-line ri-22px"></i
                         ></a>
                         </div>
                     </div>
                     </div>
                 </div>
                 <div class="col-xl-4 col-lg-6 col-md-6">
                     <div class="card">
                     <div class="card-body">
                         <div class="d-flex justify-content-between align-items-center mb-4">
                         <p class="mb-0">Total 5 users</p>
                         <ul class="list-unstyled d-flex align-items-center avatar-group mb-0">
                             <li
                             data-bs-toggle="tooltip"
                             data-popup="tooltip-custom"
                             data-bs-placement="top"
                             title="Andrew Tye"
                             class="avatar pull-up">
                             <img class="rounded-circle" src="/img/avatars/6.png" alt="Avatar" />
                             </li>
                             <li
                             data-bs-toggle="tooltip"
                             data-popup="tooltip-custom"
                             data-bs-placement="top"
                             title="Rishi Swaat"
                             class="avatar pull-up">
                             <img class="rounded-circle" src="/img/avatars/9.png" alt="Avatar" />
                             </li>
                             <li
                             data-bs-toggle="tooltip"
                             data-popup="tooltip-custom"
                             data-bs-placement="top"
                             title="Rossie Kim"
                             class="avatar pull-up">
                             <img class="rounded-circle" src="/img/avatars/12.png" alt="Avatar" />
                             </li>
                             <li class="avatar">
                             <span
                                 class="avatar-initial rounded-circle pull-up bg-lighter text-body"
                                 data-bs-toggle="tooltip"
                                 data-bs-placement="bottom"
                                 title="3 more"
                                 >+3</span
                             >
                             </li>
                         </ul>
                         </div>
                         <div class="d-flex justify-content-between align-items-center">
                         <div class="role-heading">
                             <h5 class="mb-1">Users</h5>
                             <a
                             href="javascript:;"
                             data-bs-toggle="modal"
                             data-bs-target="#RoleModal"
                             class="role-edit-modal">
                             <p class="mb-0">Edit Role</p>
                             </a>
                         </div>
                         <a href="javascript:void(0);" class="text-secondary"
                             ><i class="ri-file-copy-line ri-22px"></i
                         ></a>
                         </div>
                     </div>
                     </div>
                 </div>
                 <div class="col-xl-4 col-lg-6 col-md-6">
                     <div class="card">
                     <div class="card-body">
                         <div class="d-flex justify-content-between align-items-center mb-4">
                         <p class="mb-0">Total 3 users</p>
                         <ul class="list-unstyled d-flex align-items-center avatar-group mb-0">
                             <li
                             data-bs-toggle="tooltip"
                             data-popup="tooltip-custom"
                             data-bs-placement="top"
                             title="Kim Karlos"
                             class="avatar pull-up">
                             <img class="rounded-circle" src="/img/avatars/3.png" alt="Avatar" />
                             </li>
                             <li
                             data-bs-toggle="tooltip"
                             data-popup="tooltip-custom"
                             data-bs-placement="top"
                             title="Katy Turner"
                             class="avatar pull-up">
                             <img class="rounded-circle" src="/img/avatars/9.png" alt="Avatar" />
                             </li>
                             <li
                             data-bs-toggle="tooltip"
                             data-popup="tooltip-custom"
                             data-bs-placement="top"
                             title="Peter Adward"
                             class="avatar pull-up">
                             <img class="rounded-circle" src="/img/avatars/15.png" alt="Avatar" />
                             </li>
                             <li class="avatar">
                             <span
                                 class="avatar-initial rounded-circle pull-up bg-lighter text-body"
                                 data-bs-toggle="tooltip"
                                 data-bs-placement="bottom"
                                 title="3 more"
                                 >+3</span
                             >
                             </li>
                         </ul>
                         </div>
                         <div class="d-flex justify-content-between align-items-center">
                         <div class="role-heading">
                             <h5 class="mb-1">Support</h5>
                             <a
                             href="javascript:;"
                             data-bs-toggle="modal"
                             data-bs-target="#RoleModal"
                             class="role-edit-modal">
                             <p class="mb-0">Edit Role</p>
                             </a>
                         </div>
                         <a href="javascript:void(0);" class="text-secondary"
                             ><i class="ri-file-copy-line ri-22px"></i
                         ></a>
                         </div>
                     </div>
                     </div>
                 </div>
                 <div class="col-xl-4 col-lg-6 col-md-6">
                     <div class="card">
                     <div class="card-body">
                         <div class="d-flex justify-content-between align-items-center mb-4">
                         <p class="mb-0">Total 2 users</p>
                         <ul class="list-unstyled d-flex align-items-center avatar-group mb-0">
                             <li
                             data-bs-toggle="tooltip"
                             data-popup="tooltip-custom"
                             data-bs-placement="top"
                             title="Kim Merchent"
                             class="avatar pull-up">
                             <img class="rounded-circle" src="/img/avatars/10.png" alt="Avatar" />
                             </li>
                             <li
                             data-bs-toggle="tooltip"
                             data-popup="tooltip-custom"
                             data-bs-placement="top"
                             title="Sam D'souza"
                             class="avatar pull-up">
                             <img class="rounded-circle" src="/img/avatars/13.png" alt="Avatar" />
                             </li>
                             <li
                             data-bs-toggle="tooltip"
                             data-popup="tooltip-custom"
                             data-bs-placement="top"
                             title="Nurvi Karlos"
                             class="avatar pull-up">
                             <img class="rounded-circle" src="/img/avatars/15.png" alt="Avatar" />
                             </li>
                             <li class="avatar">
                             <span
                                 class="avatar-initial rounded-circle pull-up bg-lighter text-body"
                                 data-bs-toggle="tooltip"
                                 data-bs-placement="bottom"
                                 title="3 more"
                                 >+3</span
                             >
                             </li>
                         </ul>
                         </div>
                         <div class="d-flex justify-content-between align-items-center">
                         <div class="role-heading">
                             <h5 class="mb-1">Restricted User</h5>
                             <a
                             href="javascript:;"
                             data-bs-toggle="modal"
                             data-bs-target="#RoleModal"
                             class="role-edit-modal">
                             <p class="mb-0">Edit Role</p>
                             </a>
                         </div>
                         <a href="javascript:void(0);" class="text-secondary"
                             ><i class="ri-file-copy-line ri-22px"></i
                         ></a>
                         </div>
                     </div>
                     </div>
                 </div>
                 <div class="col-xl-4 col-lg-6 col-md-6">
                     <div class="card h-100">
                     <div class="row h-100">
                         <div class="col-5">
                         <div class="d-flex align-items-end h-100 justify-content-center">
                             <img
                             src="/img/illustrations/add-new-role-illustration.png"
                             class="img-fluid"
                             alt="Image"
                             width="68" />
                         </div>
                         </div>
                         <div class="col-7">
                         <div class="card-body text-sm-end text-center ps-sm-0">
                             <button
                             data-bs-target="#RoleModal"
                             data-bs-toggle="modal"
                             class="btn btn-sm btn-primary mb-4 text-nowrap add-new-role"
                             @click="openAddRoleModal"
                             >
                             Add Role
                             </button>
                             <p class="mb-0">
                             Add new role,<br />
                             if it doesn't exist
                             </p>
                         </div>
                         </div>
                     </div>
                     </div>
                 </div>
 
                 <div class="col-12">
                     <h4 class="mt-6 mb-1">Total users with their roles</h4>
                     <p class="mb-0">Find all of your company's administrator accounts and their associate roles.</p>
                 </div>
                 <div class="col-12">
                     <!-- Role Table -->
                     <div class="card">
                         <div class="card-datatable table-responsive py-5 px-3">
                             <table id="table-roles" class="table">
                             <thead>
                                 <tr>
                                 <th>#</th>
                                 <th>Name</th>
                                 <th>Actions</th>
                                 </tr>
                             </thead>
                             </table>
                         </div>
                     </div>
                     <!--/ Role Table -->
                 </div>
             </div>
             <!--/ Role cards -->
 
             <!-- Add Role Modal -->
             <!-- Add Role Modal -->
             <div class="modal fade" id="RoleModal" tabindex="-1" aria-hidden="true">
                <div class="modal-dialog modal-lg modal-simple modal-dialog-centered modal-add-new-role">
                    <div class="modal-content">
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        <div class="modal-body p-0">
                            <div class="text-center mb-6">
                            <h4 class="role-title mb-2 pb-0">Add New Role</h4>
                            <p>Set role permissions</p>
                            </div>
                            <div v-if="validationErrors.length" class="alert alert-danger">
                                <ul>
                                    <li v-for="err in validationErrors" :key="err.message || err">
                                    {{ typeof err === 'string' ? err : err.message }}
                                    </li>
                                </ul>
                            </div>
                            <!-- Add role form -->
                            <form id="addRoleForm" class="row g-3" onsubmit="return false">
                                <div class="col-12 mb-3">
                                    <div class="form-floating form-floating-outline">
                                    <input
                                        type="text"
                                        id="modalRoleName"
                                        name="modalRoleName"
                                        class="form-control"
                                        placeholder="Enter a role name"
                                        tabindex="-1" />
                                    <label for="modalRoleName">Role Name</label>
                                    </div>
                                </div>
                                <div class="col-12">
                                    <h5 class="mb-6">Role Permissions</h5>

                                    <div class="table-responsive">
                                    <table class="table table-flush-spacing">
                                        <tbody>
                                        <template v-if="menuDetailsWithPermissions.length > 0">
                                            <tr v-for="menuDetail in menuDetailsWithPermissions" :key="menuDetail.id">
                                            <td class="text-nowrap fw-medium">{{ menuDetail.name }}</td>
                                            <td>
                                                <div class="d-flex justify-content-end flex-wrap">
                                                    <div
                                                        v-for="perm in menuDetail.permissions"
                                                        :key="perm.id"
                                                        class="form-check mb-1 me-4"
                                                    >
                                                        <input
                                                            class="form-check-input"
                                                            type="checkbox"
                                                            :id="`perm_${menuDetail.id}_${perm.id}`"
                                                            :value="perm.id"
                                                            v-model="selectedPermissions"
                                                            :checked="selectedPermissions.includes(perm.id)"
                                                        />
                                                        <label
                                                            class="form-check-label"
                                                            :for="`perm_${menuDetail.id}_${perm.id}`"
                                                        >
                                                            {{ perm.name }}
                                                        </label>
                                                    </div>
                                                </div>
                                            </td>
                                            </tr>
                                        </template>

                                        <tr v-else>
                                            <td colspan="2" class="text-center py-4">
                                            <div class="text-muted">No permissions data available</div>
                                            </td>
                                        </tr>
                                        </tbody>
                                    </table>
                                    </div>
                                </div>
                                <div class="col-12 d-flex flex-wrap justify-content-center gap-4 row-gap-4">
                                    <button class="btn btn-primary"
                                        @click="selectedRole && selectedRole.id ? submitUpdatedPermissions() : submitNewRole()">
                                        Submit
                                    </button>
                                    <button
                                    type="reset"
                                    class="btn btn-outline-secondary"
                                    data-bs-dismiss="modal"
                                    aria-label="Close">
                                    Cancel
                                    </button>
                                </div>
                            </form>
                            <!--/ Add role form -->
                        </div>
                    </div>
                </div>
             </div>
             <!--/ Add Role Modal -->
 
             <!-- / Add Role Modal -->
         </div>
         <!-- / Content -->
 
         <div class="content-backdrop fade"></div>
     </div>
     <!-- Content wrapper -->
 </template>
 
 <script setup>
import { ref, computed, onMounted } from 'vue'
import { useRolesStore } from '~/stores/roles'
import Swal from 'sweetalert2'

const { $api } = useNuxtApp()

const permissions         = ref([])
const selectedRole        = ref(null)
const selectedPermissions = ref([])
const validationErrors    = ref([])

// Tambahkan computed ini:
const validSelectedPermissions = computed(() =>
    selectedPermissions.value
        .map(p => typeof p === 'number' ? p : parseInt(p))
        .filter(p => typeof p === 'number' && !isNaN(p) && p > 0)
);

const rolesStore = useRolesStore()

const menuDetailsWithPermissions = computed(() => {
    const result = {};
    const masterPermissions = Array.isArray(permissions.value) ? permissions.value : [];
    const masterPermissionNames = ['View', 'Create', 'Edit', 'Delete', 'Show'];

    masterPermissions.forEach(p => {
        const permParts = p.name?.split('_');
        let menuKey = '';
        if (permParts && permParts.length > 1) {
            menuKey = permParts.slice(1).join('_');
        } else {
            menuKey = 'general';
        }

        // Standarisasi menuKey ke bentuk singular (hapus trailing 's' jika ada)
        if (menuKey.endsWith('s')) {
            menuKey = menuKey.slice(0, -1);
        }

        let displayPermissionName = '';
        const permName = p.name?.toLowerCase();

        if (permName.includes('view')) displayPermissionName = 'View';
        else if (permName.includes('create')) displayPermissionName = 'Create';
        else if (permName.includes('update') || permName.includes('edit')) displayPermissionName = 'Edit';
        else if (permName.includes('delete')) displayPermissionName = 'Delete';
        else if (permName.includes('show')) displayPermissionName = 'Show';

        if (!displayPermissionName) return;

        const permissionObject = {
            id: p.id,
            name: displayPermissionName,
            dbName: p.name
        };

        if (!result[menuKey]) {
            result[menuKey] = {
                id: menuKey,
                name: menuKey.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase()),
                order: Object.keys(result).length,
                permissions: []
            };
        }

        if (!result[menuKey].permissions.some(x => x.id === permissionObject.id)) {
            result[menuKey].permissions.push(permissionObject);
        }
    });

    const sortedMenuDetails = Object.values(result).sort((a, b) => a.order - b.order);
    sortedMenuDetails.forEach(md => {
        md.permissions.sort((a, b) => {
            const orderA = masterPermissionNames.indexOf(a.name);
            const orderB = masterPermissionNames.indexOf(b.name);
            return orderA - orderB;
        });
    });

    return sortedMenuDetails;
});

// Di bagian onMounted, ganti event handler untuk tombol edit dengan ini:
onMounted(async () => {
    await fetchPermissions();

    // Hapus event handler lama sebelum DataTable diinisialisasi
    $(document).off('click', '.edit-role-btn');
    $(document).off('click', '.delete-record');

    // Inisialisasi DataTable hanya sekali
    const dataTable = $('#table-roles').DataTable({
        serverSide: true,
        processing: true,
        responsive: true,
        autoWidth: true,
        order: [[0, 'desc']],
        ajax: {
            url: $api.roles(),
            type: 'GET',
            dataSrc: function(json) {
                return json.data || json;
            },
            beforeSend: function (xhr) {
                const token = localStorage.getItem('token')
                if (token) {
                    xhr.setRequestHeader('Authorization', `Bearer ${token}`)
                }
            },
            xhrFields: {
                withCredentials: true
            }
        },
        columns: [
            { data: null, render: (data, type, row, meta) => meta.row + 1 + '.' },
            { data: 'name', defaultContent: '-' },
            { 
                data: null, 
                render: function(data, type, row) {
                    return `
                        <div class="d-flex align-items-center">
                            <span class="text-nowrap">
                                <button 
                                        class="btn btn-icon btn-text-secondary rounded-pill edit-role-btn" 
                                        data-id="${row.id}" 
                                        aria-label="Edit Role"
                                        data-bs-toggle="tooltip"
                                        data-bs-placement="top"
                                        title="Edit Role"
                                    >
                                        <i class="icon-base ri ri-edit-box-line icon-20px"></i>
                                    </button>
                                    <button
                                    class="btn btn-sm btn-icon btn-text-secondary rounded-pill delete-record text-body waves-effect me-1" data-id="${row.id}"
                                    aria-label="Delete Role"
                                    data-bs-toggle="tooltip"
                                    data-bs-placement="top"
                                    title="Delete Role"
                                    >
                                        <i class="icon-base ri ri-delete-bin-7-line icon-20px"></i>
                                    </button>
                            </span>
                        </div>
                    `;
                }
            }
        ]
    });

    // Event delegation untuk tombol edit
    $('#table-roles tbody').off('click', '.edit-role-btn').on('click', '.edit-role-btn', async function () {
        const roleId = $(this).data('id');
        try {
            const response = await fetch($api.roleShow(roleId), {
                headers: { 
                    Authorization: `Bearer ${localStorage.getItem('token')}` 
                }
            });
            
            if (!response.ok) {
                throw new Error('Gagal mengambil data role');
            }
            
            const roleData = await response.json();
            await openEditRoleModal(roleData);
            
            // Pastikan modal sudah diinisialisasi
            if (window.roleModal) {
                window.roleModal.show();
            } else {
                const modalEl = document.getElementById('RoleModal');
                window.roleModal = new bootstrap.Modal(modalEl);
                window.roleModal.show();
            }
        } catch (error) {
            console.error('Error:', error);
            alert('Gagal memuat data role: ' + error.message);
        }
    });

    // Event delegation untuk tombol delete
    $('#table-roles tbody').off('click', '.delete-record').on('click', '.delete-record', async function (e) {
        e.preventDefault();
        e.stopPropagation();
        const roleId = $(this).data('id');
        await deleteRole(roleId);
    });

    rolesStore.fetchRoles();
});

function openAddRoleModal() {
    selectedRole.value = null;
    document.getElementById('modalRoleName').value = '';
    selectedPermissions.value = [];
    if (window.roleModal) {
        window.roleModal.show();
    } else {
        const modalEl = document.getElementById('RoleModal');
        window.roleModal = new bootstrap.Modal(modalEl);
        window.roleModal.show();
    }
    // Bersihkan backdrop jika ada setelah modal ditutup
    const modalEl = document.getElementById('RoleModal');
    if (modalEl) {
        modalEl.addEventListener('hidden.bs.modal', () => {
            document.querySelectorAll('.modal-backdrop').forEach(el => el.remove());
            document.body.style.overflow = '';
        }, { once: true });
    }
}

async function openEditRoleModal(role) {
    try {
        if (!role || !role.id) {
            throw new Error('Role tidak valid');
        }

        // Debug: log role data yang diterima
        console.log('Role data loaded (openEditRoleModal):', role);

        // Simpan role yang dipilih
        selectedRole.value = role;

        // Set nilai input
        const modalRoleName = document.getElementById('modalRoleName');
        if (modalRoleName) {
            modalRoleName.value = role.name || '';
        }

        // Set permissions yang dipilih, pastikan selalu array baru
        selectedPermissions.value = [];
        
        // Handle both response formats (API might return permissions as array of objects or just IDs)
        if (role.permissions && Array.isArray(role.permissions)) {
            if (role.permissions.length > 0) {
                if (typeof role.permissions[0] === 'object') {
                    // Format: [{id: 1, name: 'view_user'}, ...]
                    selectedPermissions.value = role.permissions
                        .map(p => p.id)
                        .filter(id => id && id > 0);
                } else {
                    // Format: [1, 2, 3]
                    selectedPermissions.value = role.permissions
                        .filter(id => id && id > 0);
                }
            }
        }

        // Debug: log selectedPermissions after set
        console.log('selectedPermissions after openEditRoleModal:', selectedPermissions.value);

        // Tampilkan modal
        if (window.roleModal) {
            window.roleModal.show();
        } else {
            const modalEl = document.getElementById('RoleModal');
            window.roleModal = new bootstrap.Modal(modalEl);
            window.roleModal.show();
        }
        
        // Bersihkan backdrop jika ada setelah modal ditutup
        const modalEl = document.getElementById('RoleModal');
        if (modalEl) {
            modalEl.addEventListener('hidden.bs.modal', () => {
                document.querySelectorAll('.modal-backdrop').forEach(el => el.remove());
                document.body.style.overflow = '';
            }, { once: true });
        }

    } catch (error) {
        console.error('Error in openEditRoleModal:', error);
        alert('Error: ' + error.message);
    }
}

const fetchPermissions = async () => {
    const token = localStorage.getItem('token');
    try {
        const res = await fetch($api.getPermissions(), {
            headers: { Authorization: `Bearer ${token}` },
            credentials: 'include'
        });

        if (!res.ok) {
            console.error('HTTP Error fetching all permissions:', res.status, res.statusText);
            permissions.value = [];
            return;
        }

        const apiResponse = await res.json();
        permissions.value = apiResponse.data || apiResponse;

        console.log('Actual API Response for /api/getPermissions:', permissions.value);
        
        if (permissions.value && permissions.value.length > 0) {
            console.log('Permissions data successfully loaded. First item:', permissions.value[0]);
        } else {
            console.warn('Permissions data is empty or invalid after fetch.');
        }

    } catch (error) {
        console.error('Network or JSON parsing error fetching all permissions:', error);
        permissions.value = [];
    }
}

const submitNewRole = async () => {
    console.log('Fungsi: submitNewRole dipanggil');
    try {
        // First get the CSRF token if needed
        const csrfResponse = await fetch($api.csrfToken(), {
            credentials: 'include'
        });
        const csrfData = await csrfResponse.json();
        const csrfToken = csrfData.token || document.querySelector('meta[name="csrf-token"]')?.content;

        const token = localStorage.getItem('token');
        const url = $api.roleStore();
        
        const response = await fetch(url, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`,
                'X-CSRF-TOKEN': csrfToken || ''
            },
            credentials: 'include',
            body: JSON.stringify({
                name: document.getElementById('modalRoleName').value,
                permissionIds: validSelectedPermissions.value
            })
        });

        if (response.ok) {
            const data = await response.json();
            $('#table-roles').DataTable().ajax.reload(null, false);
            
            // Tutup modal dengan benar
            const modalEl = document.getElementById('RoleModal');
            if (modalEl) {
                const modal = bootstrap.Modal.getInstance(modalEl);
                modal.hide();
                
                // Bersihkan backdrop setelah modal tertutup
                modalEl.addEventListener('hidden.bs.modal', () => {
                    document.querySelectorAll('.modal-backdrop').forEach(el => el.remove());
                    document.body.style.overflow = '';
                }, { once: true });
            }
        } else {
            const errorData = await response.json();
            if (errorData.errors) {
            // Jika errors adalah object, flatten ke array
            validationErrors.value = Array.isArray(errorData.errors)
                ? errorData.errors
                : Object.values(errorData.errors).flat();
            } else {
                alert(errorData.message || 'Gagal membuat role');
            }  
        }
    } catch (error) {
        console.error('Create error:', error);
        alert(error.message);
    }
};

const submitUpdatedPermissions = async () => {
    try {
        if (!selectedRole.value || !selectedRole.value.id) {
            console.error('selectedRole atau ID-nya tidak ada saat update.');
            throw new Error('Role yang dipilih tidak memiliki ID. Tidak dapat memperbarui.');
        }

        const roleIdToUpdate = selectedRole.value.id;
        console.log('ID Role yang akan diupdate:', roleIdToUpdate);

        const csrfResponse = await fetch($api.csrfToken(), {
            credentials: 'include'
        });

        const csrfData = await csrfResponse.json();
        const csrfToken = csrfData.token;
        const token = localStorage.getItem('token');
        const url = $api.roleUpdate(roleIdToUpdate);
        console.log('URL yang akan dituju:', url);

        const permissionsToSend = selectedPermissions.value
        .filter(p => typeof p === 'number' && p > 0);

        console.log('Permissions yang akan dikirim (FINAL):', permissionsToSend);

        const payload = {
            name: document.getElementById('modalRoleName').value,
            permissionIds: permissionsToSend
        };
        console.log('Payload yang akan dikirim (FINAL):', payload);

        const response = await fetch(url, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`,
                'X-CSRF-TOKEN': csrfToken
            },
            body: JSON.stringify(payload),
            credentials: 'include'
        });

        if (response.ok) {
            const data = await response.json();
            $('#table-roles').DataTable().ajax.reload(null, false);

            // Reset selectedRole and selectedPermissions after update
            selectedRole.value = null;
            selectedPermissions.value = [];
            // Optionally clear the modal input
            const modalRoleName = document.getElementById('modalRoleName');
            if (modalRoleName) modalRoleName.value = '';

            // Refresh rolesStore data
            rolesStore.fetchRoles();

            // Tutup modal dengan benar
            const modalEl = document.getElementById('RoleModal');
            if (modalEl) {
                const modal = bootstrap.Modal.getInstance(modalEl);
                modal.hide();

                // Bersihkan backdrop setelah modal tertutup
                modalEl.addEventListener('hidden.bs.modal', () => {
                    document.querySelectorAll('.modal-backdrop').forEach(el => el.remove());
                    document.body.style.overflow = '';
                }, { once: true });
            }
        } else {
            const errorData = await response.json();
            if (errorData.errors) {
            // Jika errors adalah object, flatten ke array
            validationErrors.value = Array.isArray(errorData.errors)
                ? errorData.errors
                : Object.values(errorData.errors).flat();
            } else {
                alert(errorData.message || 'Gagal membuat role');
            }  
        }

    } catch (error) {
        console.error('Update error (frontend catch):', error);
        alert(error.message);
    }
};


const deleteRole = async (roleId) => {
    if (!roleId) return;

    const result = await Swal.fire({
        title: 'Are you sure?',
        text: 'This action cannot be undone!',
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#666CFF',
        cancelButtonColor: '#A7A9B3',
        confirmButtonText: 'Yes, delete it!',
        cancelButtonText: 'Cancel'
    });

    if (result.isConfirmed) {
        try {
            // Validasi ID role yang akan dihapus
            if (!roleId) {
                console.error('ID role tidak ditemukan untuk proses hapus.');
                throw new Error('Role yang dipilih tidak memiliki ID. Tidak dapat menghapus.');
            }

            // Ambil token dari localStorage
            const token = localStorage.getItem('token');

            // Ambil CSRF token
            const csrfResponse = await fetch($api.csrfToken(), {
                credentials: 'include'
            });
            const csrfData = await csrfResponse.json();
            const csrfToken = csrfData.token;

            // Endpoint hapus role
            const url = $api.roleDelete(roleId);
            console.log('URL hapus role:', url);

            // Request hapus role
            const response = await fetch(url, {
                method: 'DELETE',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`,
                    'X-CSRF-TOKEN': csrfToken
                },
                credentials: 'include'
            });

            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.message || 'Gagal menghapus role');
            }

            // Reload tabel
            $('#table-roles').DataTable().ajax.reload(null, false);

            await Swal.fire({
                title: 'Berhasil!',
                text: 'Role berhasil dihapus.',
                icon: 'success'
            });

        } catch (error) {
            await Swal.fire({
                title: 'Error',
                text: error.message,
                icon: 'error'
            });
        }
    }
};

 </script>
 
 <style>
    
 </style>